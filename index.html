<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sales Force V39 - Platinum Cloud</title>
    
    <!-- CONFIGURAÃ‡Ã•ES PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" type="image/png" href="https://i.postimg.cc/MTGzyVGF/file-0000000092c471f5b7a5391ae5ba35f5-1.png">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/MTGzyVGF/file-0000000092c471f5b7a5391ae5ba35f5-1.png">

    <!-- SDKs FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">

    <style>
        body { background-color: #0f172a; color: white; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; overflow: hidden; }
        .glass { background: #1e293b; border: 1px solid #334155; }
        .input-box { background: #020617; border: 1px solid #334155; color: white; width: 100%; padding: 12px; border-radius: 12px; outline: none; transition: 0.2s; font-size: 16px; }
        .input-box:focus { border-color: #3b82f6; box-shadow: 0 0 15px rgba(59, 130, 246, 0.3); }
        .hidden { display: none !important; }
        .bar-bg { background: #334155; height: 10px; border-radius: 99px; overflow: hidden; }
        .bar-fill { height: 100%; transition: width 1s ease-in-out; }
        #loading { background: #0f172a; position: fixed; inset: 0; z-index: 9999; display: flex; flex-direction: column; items-center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #1e293b; border-top: 4px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .modal-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <div id="loading">
        <div class="spinner"></div>
        <p class="mt-4 text-[10px] text-blue-400 font-bold uppercase animate-pulse tracking-widest text-center px-6">Verificando Blindagem v39.0...</p>
    </div>

    <!-- LOGIN -->
    <div id="view-login" class="fixed inset-0 z-50 flex items-center justify-center p-6 bg-[#0f172a] hidden text-center">
        <div class="glass rounded-[2rem] w-full max-w-sm shadow-2xl overflow-hidden border border-gray-700">
            <img src="https://i.postimg.cc/MTGzyVGF/file-0000000092c471f5b7a5391ae5ba35f5-1.png" class="w-full h-auto">
            <div class="p-8 pt-4 space-y-4">
                <input type="text" id="login-user" class="input-box text-center font-black uppercase tracking-widest" placeholder="USUÃRIO">
                <input type="password" id="login-pass" class="input-box text-center font-black" placeholder="SENHA">
                <button onclick="sys.login()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-xl shadow-lg uppercase tracking-widest text-sm">Entrar no Sistema</button>
            </div>
            <p id="login-msg" class="text-red-400 text-[10px] pb-6 font-bold uppercase tracking-widest"></p>
        </div>
    </div>

    <!-- APP PRINCIPAL -->
    <div id="view-app" class="hidden flex flex-col h-full">
        <header class="bg-[#0f172a] pt-10 pb-4 px-5 flex justify-between items-end h-[105px] border-b border-gray-800 shadow-xl">
            <div class="flex items-center gap-3">
                <img src="https://i.postimg.cc/MTGzyVGF/file-0000000092c471f5b7a5391ae5ba35f5-1.png" class="w-12 h-12 rounded-lg border border-gray-700 shadow-lg">
                <div>
                    <p class="text-gray-500 text-[9px] uppercase font-bold tracking-widest leading-none">Painel Oficial</p>
                    <h2 class="text-xl font-black text-white uppercase leading-none" id="u-name">...</h2>
                </div>
            </div>
            <button onclick="sys.logout()" class="w-11 h-11 bg-red-500/10 rounded-xl text-red-500 border border-red-500/20 active:scale-90 transition"><i class="fas fa-power-off text-xs"></i></button>
        </header>

        <main class="flex-1 overflow-y-auto p-4 pb-32">
            
            <!-- ABA HOME -->
            <div id="tab-home" class="space-y-6">
                <!-- Meta da Loja (VisÃ­vel para todos se configurado pelo Gerente) -->
                <div id="store-goal-area" class="glass p-5 rounded-3xl border-l-4 border-amber-500 hidden">
                    <div class="flex justify-between items-center mb-1"><span class="text-[10px] font-black uppercase text-amber-500">Meta Global da Loja</span><span class="text-xs font-black" id="store-goal-pct">0%</span></div>
                    <div class="bar-bg mb-2"><div id="store-bar-fill" class="bar-fill bg-amber-500" style="width: 0%"></div></div>
                    <p class="text-[9px] text-gray-500 text-center font-bold" id="store-goal-text">Sincronizando...</p>
                </div>

<!-- BOTÃƒO META INDIVIDUAL -->
<div class="mb-4">
    <a href="meta-individual.html" class="glass p-4 rounded-2xl flex justify-between items-center border border-blue-500/30 shadow-lg active:scale-95 transition text-decoration-none">
        <div class="flex items-center gap-4">
            <div class="bg-blue-600/20 p-3 rounded-full text-blue-400 border border-blue-500/30">
                <i class="fas fa-crosshairs text-xl"></i>
            </div>
            <div class="text-left">
                <p class="text-[9px] text-gray-400 font-black uppercase tracking-widest">Acompanhamento</p>
                <h3 class="text-sm font-black text-white uppercase">Minha Performance</h3>
            </div>
        </div>
        <div class="bg-black/20 w-8 h-8 rounded-full flex items-center justify-center">
            <i class="fas fa-chevron-right text-xs text-gray-500"></i>
        </div>
    </a>
</div>
                
                <div class="grid grid-cols-2 gap-3 text-center">
                    <div class="glass p-5 rounded-2xl border-l-4 border-blue-500 shadow-xl"><p class="text-[9px] text-blue-400 font-bold uppercase">Vendido MÃªs</p><h3 class="text-xl font-black text-white" id="d-total">R$ 0,00</h3></div>
                    <div class="glass p-5 rounded-2xl border-l-4 border-green-500 shadow-xl"><p class="text-[9px] text-green-400 font-bold uppercase">ComissÃ£o (2.2%)</p><h3 class="text-xl font-black text-white" id="d-my-profit">R$ 0,00</h3></div>
                </div>

                <!-- Card de Ganho do Gerente (Oculto para Vendedor) -->
                <div id="mgr-profit-card" class="glass p-6 rounded-3xl border-l-4 border-purple-500 hidden text-center">
                    <p class="text-[10px] text-purple-400 font-bold uppercase tracking-widest">Ganho Gerencial Equipe</p>
                    <h3 class="text-3xl font-black text-white" id="r-mgr-team-profit">R$ 0,00</h3>
                </div>

                <div class="mb-2">
                    <button onclick="sys.openModal('modal-pedido')" class="w-full bg-blue-600 text-white p-6 rounded-[1.5rem] flex items-center justify-center gap-4 shadow-xl uppercase font-black tracking-widest text-lg"><i class="fas fa-plus-circle text-2xl"></i> Novo Pedido</button>
                </div>

                <!-- 7 CARDS RESUMO -->
                <h3 class="text-gray-500 text-[10px] font-black uppercase mb-2 pl-1">Resumo de Ganhos</h3>
                <div class="grid grid-cols-2 gap-3" id="resumo-grid">
                    <div class="glass p-4 rounded-xl text-center"><span class="text-[9px] text-blue-400 font-bold block uppercase">MonetÃ¡rio 2.2%</span><span class="text-lg font-black text-white" id="r-cprod">R$ 0</span></div>
                    <div class="glass p-4 rounded-xl text-center"><span class="text-[9px] text-green-400 font-bold block uppercase">AssistÃªncia 5%</span><span class="text-lg font-black text-white" id="r-assist">R$ 0</span></div>
                    <div class="glass p-4 rounded-xl text-center"><span class="text-[9px] text-purple-300 font-bold block uppercase">BÃ´nus Imper (40)</span><span class="text-lg font-black text-white" id="r-bonus-imper">R$ 0</span></div>
                    <div class="glass p-4 rounded-xl text-center"><span class="text-[9px] text-cyan-400 font-bold block uppercase">Extra Lavagem (40)</span><span class="text-lg font-black text-white" id="r-lav">R$ 0</span></div>
                    <div class="glass p-4 rounded-xl text-center"><span class="text-[9px] text-blue-400 font-bold block uppercase">Extra Montagem (10)</span><span class="text-lg font-black text-white" id="r-mon">R$ 0</span></div>
                    <div class="glass p-4 rounded-xl text-center"><span class="text-[9px] text-pink-400 font-bold block uppercase">Extra Almofada (10)</span><span class="text-lg font-black text-white" id="r-alm">R$ 0</span></div>
                    <div class="glass p-4 rounded-xl col-span-2 text-center"><span class="text-[9px] text-yellow-400 font-bold block uppercase">Extra PÃ©s Guarda-roupa (7)</span><span class="text-xl font-black text-white" id="r-pes">R$ 0</span></div>
                </div>

                <h3 class="text-xs font-black text-gray-600 uppercase px-1 mb-2">HistÃ³rico de Vendas</h3>
                <div id="list-sales" class="space-y-3 pb-10"></div>
            </div>

            <!-- ABA DONO DO DINHEIRO -->
            <div id="tab-news" class="hidden space-y-6">
                <div class="text-center py-6">
                    <i class="fas fa-sack-dollar text-5xl text-amber-500 mb-2"></i>
                    <h2 class="text-xl font-black uppercase tracking-widest">Dono do Dinheiro</h2>
                </div>
                <div class="px-2">
                    <div class="glass p-8 rounded-[2rem] text-center border border-amber-500/30">
                        <p class="text-amber-200 font-bold italic">Liberado em breve</p>
                    </div>
                </div>
            </div>

            <!-- RANKING -->
            <div id="tab-ranking" class="hidden space-y-6 text-center">
                <div class="py-6"><i class="fas fa-medal text-5xl text-yellow-500 mb-2"></i><h2 class="text-xl font-black uppercase tracking-widest">Ranking da Loja</h2></div>
                <div id="ranking-list" class="space-y-4 px-2 pb-20"></div>
            </div>

            <!-- METAS -->
            <div id="tab-metas" class="hidden space-y-6 text-center">
                <div class="bg-gradient-to-br from-indigo-900 via-purple-900 to-blue-900 p-8 rounded-[2.5rem] border border-purple-500/30 shadow-2xl">
                    <p class="text-purple-300 text-[10px] font-bold uppercase">BÃ´nus Performance Estimado</p>
                    <h2 class="text-4xl font-black my-2" id="m-bonus">R$ 0,00</h2>
                    <span id="m-badge" class="bg-black/30 px-5 py-1 rounded-full text-[11px] font-black text-yellow-400 border border-yellow-500/30">NÃ­vel 0</span>
                </div>
                <div id="goals-bars" class="space-y-5"></div>
            </div>

            <!-- EQUIPE E AJUSTES DO GERENTE (RESTAURADO) -->
            <div id="tab-team" class="hidden space-y-6 pb-20">
                <div class="glass p-6 rounded-[2rem] text-center">
                    <h3 class="font-black text-xs text-gray-300 uppercase mb-4">Cadastrar Vendedor</h3>
                    <input type="text" id="mgr-new-user" class="input-box uppercase mb-2 font-black" placeholder="NOME">
                    <input type="password" id="mgr-new-pass" class="input-box mb-3 font-black" placeholder="SENHA">
                    <button onclick="sys.mgrCreateSeller()" class="w-full bg-blue-600 font-black py-4 rounded-xl uppercase text-xs">Cadastrar</button>
                </div>

                <div class="glass p-6 rounded-[2rem] border-l-4 border-purple-500 shadow-xl">
                    <h3 class="text-purple-500 font-black text-xs uppercase mb-4 text-center">ConfiguraÃ§Ã£o de Ganhos Equipe (R$)</h3>
                    <div class="grid grid-cols-2 gap-3 text-[10px] font-black uppercase text-gray-500">
                        <div>Lavagem<input type="number" id="mgr-val-lav" class="input-box text-center p-2 mt-1"></div>
                        <div>Imper<input type="number" id="mgr-val-imp" class="input-box text-center p-2 mt-1"></div>
                        <div>Montagem<input type="number" id="mgr-val-mon" class="input-box text-center p-2 mt-1"></div>
                        <div>Almofada<input type="number" id="mgr-val-alm" class="input-box text-center p-2 mt-1"></div>
                        <div class="col-span-2">PÃ©s G-Roupa<input type="number" id="mgr-val-pes" class="input-box text-center p-2 mt-1"></div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-700 text-center">
                        <label class="text-[9px] text-amber-500 font-black uppercase">Meta Bruta da Loja (R$)</label>
                        <input type="number" id="mgr-goal-p" class="input-box text-center font-black mt-1">
                    </div>
                    <button onclick="sys.mgrUpdateStoreSettings()" class="w-full bg-purple-600 font-black py-3 rounded-xl uppercase text-[10px] mt-4">Salvar Ajustes da Loja</button>
                </div>

                <div id="mgr-team-list" class="space-y-3"></div>
            </div>

            <!-- AJUSTES ADMIN MASTER -->
            <div id="tab-config" class="hidden space-y-4">
                <div class="glass p-6 rounded-[2rem] border-l-4 border-yellow-500 shadow-xl">
                    <h3 class="text-yellow-500 font-black text-xs uppercase mb-6">Metas Globais da Rede</h3>
                    <div id="config-inputs-area" class="space-y-6"></div>
                </div>
                <button onclick="sys.saveConfig()" class="w-full bg-blue-600 font-black py-4 rounded-xl uppercase text-xs">Salvar Rede</button>
            </div>

            <!-- ADMIN MASTER -->
            <div id="tab-admin" class="hidden space-y-6 pb-32">
                <div class="glass p-6 rounded-[2rem] shadow-xl border border-blue-500">
                    <h3 class="font-black text-xs uppercase mb-4 text-blue-400">Novo Acesso Unidade</h3>
                    <input type="text" id="adm-new-name" class="input-box uppercase mb-2 font-bold" placeholder="USUÃRIO">
                    <input type="password" id="adm-new-pass" class="input-box mb-2 font-bold" placeholder="SENHA">
                    <input type="text" id="adm-new-store" class="input-box uppercase mb-2 font-bold" placeholder="LOJA">
                    <select id="adm-new-role" class="input-box mb-3 bg-gray-900 font-bold">
                        <option value="manager">GERENTE DE LOJA</option>
                        <option value="seller">VENDEDOR AVULSO</option>
                    </select>
                    <button onclick="sys.adminCreateUser()" class="w-full bg-blue-600 font-black py-4 rounded-xl uppercase text-xs">Criar Acesso</button>
                </div>
                <div id="adm-user-list" class="space-y-3"></div>
            </div>
        </main>

        <nav class="glass fixed bottom-0 w-full z-40 flex justify-around items-center h-[75px] border-t border-gray-800 text-gray-500 shadow-2xl">
            <button onclick="sys.nav('home')" id="nav-home" class="flex-1 flex flex-col items-center gap-1 text-blue-500 font-black transition-all"><i class="fas fa-home text-xl"></i><span class="text-[9px] uppercase">Painel</span></button>
            <button onclick="sys.nav('news')" id="nav-news" class="flex-1 flex flex-col items-center gap-1 font-black transition-all"><i class="fas fa-sack-dollar text-xl"></i><span class="text-[9px] uppercase">Dono</span></button>
            <button onclick="sys.nav('ranking')" id="nav-ranking" class="flex-1 flex flex-col items-center gap-1 font-black transition-all"><i class="fas fa-medal text-xl"></i><span class="text-[9px] uppercase">Ranking</span></button>
            <button onclick="sys.nav('metas')" id="nav-metas" class="flex-1 flex flex-col items-center gap-1 font-black transition-all"><i class="fas fa-bullseye text-xl"></i><span class="text-[9px] uppercase">Metas</span></button>
            <button onclick="sys.nav('team')" id="nav-team" class="hidden flex-1 flex flex-col items-center gap-1 font-black transition-all"><i class="fas fa-users-cog text-xl"></i><span class="text-[9px] uppercase">Equipe</span></button>
            <button onclick="sys.nav('config')" id="nav-config" class="hidden flex-1 flex flex-col items-center gap-1 font-black transition-all"><i class="fas fa-sliders-h text-xl"></i><span class="text-[9px] uppercase">Ajustes</span></button>
            <button onclick="sys.nav('admin')" id="nav-admin" class="hidden flex-1 flex flex-col items-center gap-1 font-black transition-all"><i class="fas fa-crown text-xl"></i><span class="text-[9px] uppercase">Admin</span></button>
        </nav>
    </div>

    <!-- MODAL DETALHE PEDIDO -->
    <div id="modal-detalhe" class="fixed inset-0 z-[110] hidden items-center justify-center bg-black/90 p-4 backdrop-blur-sm">
        <div class="bg-[#1e293b] w-full max-w-sm rounded-[2rem] border border-gray-700 shadow-2xl overflow-hidden text-center uppercase font-black">
            <div id="det-corpo" class="p-8 text-sm"></div>
            <div class="p-4 bg-gray-900 flex gap-2 border-t border-gray-800">
                <button id="det-btn-del" class="flex-1 bg-red-600/10 text-red-500 font-bold py-4 rounded-xl border border-red-500/20 text-[10px]">Excluir</button>
                <button onclick="sys.closeModal('modal-detalhe')" class="flex-1 bg-gray-700 font-bold py-4 rounded-xl text-[10px] text-white">Voltar</button>
            </div>
        </div>
    </div>

    <!-- MODAL NOVO PEDIDO -->
    <div id="modal-pedido" class="fixed inset-0 z-[100] hidden items-end justify-center bg-black/80 backdrop-blur-sm text-center font-black">
        <div class="bg-[#1e293b] w-full max-w-md rounded-t-[2.5rem] p-8 modal-up border-t border-blue-500/30">
            <div class="flex justify-between items-center mb-6"><h2 class="uppercase text-blue-400 text-lg">Novo Pedido</h2><button onclick="sys.closeModal('modal-pedido')"><i class="fas fa-times"></i></button></div>
            <div class="space-y-5">
                <input type="tel" id="i-ord" placeholder="NÂº DO PEDIDO" class="input-box text-center font-bold text-xl border-blue-500/30">
                <div class="grid grid-cols-3 gap-2">
                    <div><label class="text-[9px] font-black text-gray-500">Venda</label><input type="number" id="i-prod" class="input-box text-center p-2 font-black" oninput="sys.calc()"></div>
                    <div><label class="text-[9px] font-black text-gray-500">Assis</label><input type="number" id="i-ass" class="input-box text-center p-2 font-black" oninput="sys.calc()"></div>
                    <div><label class="text-[9px] font-black text-gray-500">Imper</label><input type="number" id="i-imp" class="input-box text-center p-2 font-black" oninput="sys.calc()"></div>
                </div>
                <div class="grid grid-cols-2 gap-2 text-[10px] bg-black/20 p-5 rounded-2xl border border-gray-700 font-black">
                    <div class="flex justify-between items-center">Lavagem (40)<input id="q-lav" type="number" class="w-8 bg-blue-600 rounded text-center" oninput="sys.calc()"></div>
                    <div class="flex justify-between items-center">Imper (40)<input id="q-imp" type="number" class="w-8 bg-blue-600 rounded text-center" oninput="sys.calc()"></div>
                    <div class="flex justify-between items-center">Montagem (10)<input id="q-mon" type="number" class="w-8 bg-blue-600 rounded text-center" oninput="sys.calc()"></div>
                    <div class="flex justify-between items-center">Almofada (10)<input id="q-alm" type="number" class="w-8 bg-blue-600 rounded text-center" oninput="sys.calc()"></div>
                    <div class="flex justify-between items-center col-span-2 pt-2 border-t border-gray-700 text-center">PÃ©s G-Roupa (7)<input id="q-pes" type="number" class="w-8 bg-blue-600 rounded text-center" oninput="sys.calc()"></div>
                </div>
                <div class="flex justify-between font-black text-green-400 pt-2 uppercase text-[10px]"><span>PrevisÃ£o ComissÃ£o:</span><span id="preview">R$ 0,00</span></div>
                <button onclick="sys.saveOrder()" id="btn-save" class="w-full bg-blue-600 py-5 rounded-xl font-black uppercase shadow-lg transition active:scale-95">Salvar na Nuvem</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAZ6Zp-XRhmJaqyrA806YxGAYo3TyFttpQ",
            authDomain: "b-dados-sistema.firebaseapp.com",
            projectId: "b-dados-sistema",
            storageBucket: "b-dados-sistema.firebasestorage.app",
            messagingSenderId: "725143488446",
            appId: "1:725143488446:web:ab7178929e9c9b8dcf9bef"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const sys = {
            user: null, allSales: [], config: {}, storeData: {},
            
            async init() {
                setTimeout(() => { if(!this.user) { document.getElementById('loading').style.display='none'; document.getElementById('view-login').classList.remove('hidden'); } }, 3000);
            },

            async login() {
                const u = document.getElementById('login-user').value.toLowerCase().trim();
                const p = document.getElementById('login-pass').value.trim();
                if(!u || !p) return;
                document.getElementById('loading').style.display='flex';
                try {
                    const uDoc = await db.collection('users').doc(u).get();
                    if(!uDoc.exists || uDoc.data().p !== p) throw new Error("Acesso negado.");
                    const data = uDoc.data();
                    if(data.b) throw new Error("UsuÃ¡rio Bloqueado.");
                    if(data.r !== 'admin' && Date.now() > data.exp) throw new Error("Acesso Expirado.");
                    
                    this.user = { id: u, ...data };
                    localStorage.setItem('usuario_v39', u);
                    await db.collection('users').doc(u).update({ lastSeen: Date.now() });
                    
                    document.getElementById('u-name').innerText = u;
                    if(data.r === 'admin') { document.getElementById('nav-admin').classList.remove('hidden'); document.getElementById('nav-config').classList.remove('hidden'); }
                    if(data.r === 'manager') document.getElementById('nav-team').classList.remove('hidden');

                    await this.loadInitialData();
                    document.getElementById('view-login').classList.add('hidden');
                    document.getElementById('view-app').classList.remove('hidden');
                    this.renderHome();
                } catch(e) { document.getElementById('login-msg').innerText = e.message; }
                document.getElementById('loading').style.display='none';
            },

            async loadInitialData() {
                const confDoc = await db.collection('settings').doc('global').get();
                this.config = confDoc.exists ? confDoc.data() : { n1:{p:70000,a:720,i:720}, n2:{p:80000,a:2200,i:2160}, n3:{p:96000,a:3000,i:3000} };
                
                let query = db.collection('sales');
                if(this.user.r === 'seller') query = query.where('seller', '==', this.user.id);
                if(this.user.r === 'manager') query = query.where('store', '==', this.user.store);
                
                const snap = await query.get();
                this.allSales = snap.docs.map(d => ({id:d.id, ...d.data()})).sort((a,b) => b.date.localeCompare(a.date));

                if(this.user.store) {
                    const sDoc = await db.collection('stores').doc(this.user.store).get();
                    this.storeData = sDoc.exists ? sDoc.data() : { goal:0, valLav:0, valImp:0, valMon:0, valAlm:0, valPes:0 };
                }
            },

            renderHome() {
                const mes = new Date().toISOString().slice(0,7);
                const filtradosMeus = this.allSales.filter(s => s.date.startsWith(mes) && s.seller === this.user.id);
                const filtradosLoja = this.allSales.filter(s => s.date.startsWith(mes));

                let t = {p:0, a:0, i:0, lav:0, mon:0, pes:0, alm:0, impBonus:0};
                filtradosMeus.forEach(s => {
                    t.p += (s.v.p || 0); t.a += (s.v.a || 0); t.i += (s.v.i || 0);
                    t.lav += (s.q?.lav||0)*40; t.mon += (s.q?.mon||0)*10;
                    t.pes += (s.q?.pes||0)*7; t.alm += (s.q?.alm||0)*10; t.impBonus += (s.q?.imp||0)*40;
                });

                // LÃ³gica Ganho Gerente
                if(this.user.r === 'manager') {
                    let lT = {lav:0, imp:0, mon:0, alm:0, pes:0};
                    filtradosLoja.forEach(s => { 
                        lT.lav += (s.q?.lav||0); lT.imp += (s.q?.imp||0); 
                        lT.mon += (s.q?.mon||0); lT.alm += (s.q?.alm||0); lT.pes += (s.q?.pes||0); 
                    });
                    const teamProfit = (lT.lav * (this.storeData.valLav||0)) + (lT.imp * (this.storeData.valImp||0)) + (lT.mon * (this.storeData.valMon||0)) + (lT.alm * (this.storeData.valAlm||0)) + (lT.pes * (this.storeData.valPes||0));
                    document.getElementById('mgr-profit-card').classList.remove('hidden');
                    document.getElementById('r-mgr-team-profit').innerText = this.fmt(teamProfit);
                }

                // Cards do Painel
                document.getElementById('d-total').innerText = this.fmt(t.p);
                document.getElementById('d-my-profit').innerText = this.fmt(t.p * 0.022);
                document.getElementById('r-cprod').innerText = this.fmt(t.p * 0.022);
                document.getElementById('r-assist').innerText = this.fmt(t.a * 0.05);
                document.getElementById('r-bonus-imper').innerText = this.fmt(t.impBonus);
                document.getElementById('r-lav').innerText = this.fmt(t.lav);
                document.getElementById('r-mon').innerText = this.fmt(t.mon);
                document.getElementById('r-pes').innerText = this.fmt(t.pes);
                document.getElementById('r-alm').innerText = this.fmt(t.alm);

                // Meta da Loja
                if(this.user.store && this.storeData.goal > 0) {
                    const totalVendidoLoja = filtradosLoja.reduce((acc, curr) => acc + (curr.v.p || 0), 0);
                    const pctL = Math.min((totalVendidoLoja / this.storeData.goal) * 100, 100).toFixed(1);
                    document.getElementById('store-goal-area').classList.remove('hidden');
                    document.getElementById('store-bar-fill').style.width = pctL + '%';
                    document.getElementById('store-goal-pct').innerText = pctL + '%';
                    document.getElementById('store-goal-text').innerText = `LOJA: ${this.user.store} | R$ ${totalVendidoLoja.toLocaleString()}`;
                }

                const C = this.config;
                let pct = (t.p>=C.n3.p && t.a>=C.n3.a && t.i>=C.n3.i) ? 0.011 : (t.p>=C.n2.p && t.a>=C.n2.a && t.i>=C.n2.i) ? 0.008 : (t.p>=C.n1.p && t.a>=C.n1.a && t.i>=C.n1.i) ? 0.006 : 0;
                document.getElementById('m-bonus').innerText = this.fmt(t.p * pct);
                document.getElementById('m-badge').innerText = pct > 0 ? `NÃVEL ATINGIDO!` : "NÃVEL 0";
                document.getElementById('goals-bars').innerHTML = `${this.renderBar("Produto", t.p, C.n2.p, "blue")}${this.renderBar("AssistÃªncia", t.a, C.n2.a, "green")}${this.renderBar("ImpermeabilizaÃ§Ã£o", t.i, C.n2.i, "purple")}`;

                const list = document.getElementById('list-sales'); list.innerHTML = "";
                filtradosMeus.forEach(s => {
                    list.innerHTML += `<div onclick="sys.verDetalhe('${s.id}')" class="glass p-4 mb-2 rounded-xl flex justify-between items-center shadow-md active:scale-95 transition"><div><span class="text-[10px] text-gray-500 font-bold">${new Date(s.date).toLocaleDateString()}</span><div class="font-black text-sm text-white">Pedido #${s.order}</div></div><div class="text-right text-green-400 font-black">+ ${this.fmt(s.preview)}</div></div>`;
                });
            },

            verDetalhe(id) {
                const s = this.allSales.find(x => x.id === id);
                if(!s) return;
                document.getElementById('det-corpo').innerHTML = `<h3 class="font-black text-xl mb-4 text-blue-400">Pedido #${s.order}</h3><div class="space-y-2 text-left text-[11px] border-b border-gray-700 pb-4 mb-4 font-black"><div class="flex justify-between"><span>Venda Produto:</span><b>${this.fmt(s.v.p)}</b></div><div class="flex justify-between"><span>Venda AssistÃªncia:</span><b>${this.fmt(s.v.a)}</b></div><div class="flex justify-between"><span>Venda Imper:</span><b>${this.fmt(s.v.i||0)}</b></div></div><div class="grid grid-cols-2 gap-2 text-[10px] text-gray-400 bg-black/20 p-4 rounded-xl mb-4 font-black"><span>Lavagem: ${s.q?.lav||0}</span><span>Imper Extras: ${s.q?.imp||0}</span><span>Montagem: ${s.q?.mon||0}</span><span>Almofada: ${s.q?.alm||0}</span><span class="col-span-2 pt-2 border-t border-gray-800">PÃ©s: ${s.q?.pes||0}</span></div><p class="text-green-400 text-3xl font-black">${this.fmt(s.preview)}</p>`;
                document.getElementById('det-btn-del').onclick = () => this.delOrder(id);
                this.openModal('modal-detalhe');
            },

            async saveOrder() {
                const ord = document.getElementById('i-ord').value;
                if(!ord) { alert("NÂº do pedido!"); return; }
                const c = this.calc();
                document.getElementById('loading').style.display='flex';
                try {
                    await db.collection('sales').add({ seller: this.user.id, store: this.user.store, order: ord, v: {p:parseFloat(c.p)||0, a:parseFloat(c.a)||0, i:parseFloat(c.i)||0}, bonus: c.f, preview: c.t, date: new Date().toISOString(), q: {lav:this.g('q-lav'), imp:this.g('q-imp'), mon:this.g('q-mon'), alm:this.g('q-alm'), pes:this.g('q-pes')} });
                    await db.collection('users').doc(this.user.id).update({ lastSeen: Date.now() });
                    ["i-ord","i-prod","i-ass","i-imp","q-lav","q-imp","q-mon","q-alm","q-pes"].forEach(id => document.getElementById(id).value = "");
                    document.getElementById('preview').innerText = "R$ 0,00";
                    await this.loadInitialData(); this.closeModal('modal-pedido'); this.renderHome();
                    alert("Salvo com sucesso!");
                } catch(e) { alert("Erro ao salvar."); }
                document.getElementById('loading').style.display='none';
            },

            // AJUSTES DO GERENTE
            async mgrUpdateStoreSettings() {
                const d = { 
                    goal: parseFloat(document.getElementById('mgr-goal-p').value)||0, 
                    valLav: parseFloat(document.getElementById('mgr-val-lav').value)||0, 
                    valImp: parseFloat(document.getElementById('mgr-val-imp').value)||0, 
                    valMon: parseFloat(document.getElementById('mgr-val-mon').value)||0, 
                    valAlm: parseFloat(document.getElementById('mgr-val-alm').value)||0, 
                    valPes: parseFloat(document.getElementById('mgr-val-pes').value)||0 
                };
                await db.collection('stores').doc(this.user.store).set(d);
                this.storeData = d; alert("ConfiguraÃ§Ãµes da Loja Salvas!"); this.renderHome();
            },

            async renderAdmin() {
                const snap = await db.collection('users').get();
                const list = document.getElementById('adm-user-list'); list.innerHTML = "";
                snap.forEach(doc => {
                    const u = doc.data(); if(doc.id === 'admin') return;
                    const dias = Math.max(0, Math.ceil((u.exp - Date.now()) / 86400000));
                    const last = u.lastSeen ? new Date(u.lastSeen).toLocaleDateString() + " Ã s " + new Date(u.lastSeen).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : "Nunca";
                    list.innerHTML += `<div class="glass p-4 rounded-2xl mb-3 text-left font-black"><div class="flex justify-between items-center mb-1"><span class="uppercase text-sm">${doc.id}</span><span class="text-blue-400 text-xs">${dias} Dias</span></div><p class="text-[9px] text-gray-500 uppercase">Loja: <span class="text-white">${u.store}</span> | Visto: <span class="text-green-400">${last}</span></p><div class="flex gap-2 my-2 bg-black/30 p-2 rounded-xl border border-gray-700"><input type="text" id="tr-${doc.id}" class="flex-1 bg-transparent text-[10px] outline-none" placeholder="NOVA LOJA"><button onclick="sys.adminTransfer('${doc.id}')" class="bg-blue-600 px-3 py-1 rounded-lg text-[8px]">TRANSFERIR</button></div><div class="flex gap-2"><select id="mo-${doc.id}" class="flex-1 bg-gray-900 border border-gray-700 rounded-lg text-[10px] p-2"><option value="1">+1 MÃªs</option><option value="3">+3 Meses</option><option value="12">+1 Ano</option></select><button onclick="sys.adminRenovar('${doc.id}')" class="bg-green-600 px-4 rounded-lg text-[9px]">RENOVAR</button><button onclick="sys.adminToggle('${doc.id}')" class="bg-gray-700 px-3 rounded-lg text-[9px]">${u.b?'Ativar':'Bloquear'}</button><button onclick="sys.adminDel('${doc.id}')" class="bg-red-900/40 px-3 rounded-lg text-[9px]"><i class="fas fa-trash"></i></button></div></div>`;
                });
            },

            async adminTransfer(id) {
                const s = document.getElementById(`tr-${id}`).value.toUpperCase().trim();
                if(!s) return;
                await db.collection('users').doc(id).update({ store: s }); alert("Transferido!"); this.renderAdmin();
            },

            async adminRenovar(id) {
                const m = parseInt(document.getElementById(`mo-${id}`).value);
                const doc = await db.collection('users').doc(id).get();
                const exp = Math.max(Date.now(), doc.data().exp) + (m * 30 * 86400000);
                await db.collection('users').doc(id).update({ exp: exp }); this.renderAdmin();
            },

            async adminToggle(id) { const doc = await db.collection('users').doc(id).get(); await db.collection('users').doc(id).update({ b: !doc.data().b }); this.renderAdmin(); },
            async adminDel(id) { if(confirm("Apagar?")) { await db.collection('users').doc(id).delete(); this.renderAdmin(); } },
            async adminCreateUser() {
                const n = document.getElementById('adm-new-name').value.toLowerCase().trim();
                const p = document.getElementById('adm-new-pass').value;
                const s = document.getElementById('adm-new-store').value.toUpperCase().trim();
                const r = document.getElementById('adm-new-role').value;
                if(!n||!p||!s) return;
                await db.collection('users').doc(n).set({ p, r, store: s, exp: Date.now()+(30*86400000), b: false, lastSeen: 0 });
                alert("Criado!"); this.renderAdmin();
            },

            async mgrCreateSeller() {
                const n = document.getElementById('mgr-new-user').value.toLowerCase().trim();
                const p = document.getElementById('mgr-new-pass').value;
                if(!n||!p) return;
                await db.collection('users').doc(n).set({ p, r:'seller', store: this.user.store, exp: Date.now()+(30*86400000), b: false, lastSeen: 0 });
                alert("Vendedor Criado!"); this.renderTeam();
            },

            async renderTeam() {
                const list = document.getElementById('mgr-team-list'); list.innerHTML = "";
                const snap = await db.collection('users').where('store', '==', this.user.store).get();
                snap.forEach(doc => { if(doc.id !== this.user.id) list.innerHTML += `<div class="glass p-3 rounded-xl flex justify-between items-center"><span class="uppercase font-black text-xs">${doc.id}</span><button onclick="sys.adminToggle('${doc.id}')" class="text-[10px]">${doc.data().b ? 'ðŸ”´':'ðŸŸ¢'}</button></div>`; });
            },

            async saveConfig() {
                const cfg = { n1:{p:this.g('c-n1-prod'),a:this.g('c-n1-ass'),i:this.g('c-n1-imp')}, n2:{p:this.g('c-n2-prod'),a:this.g('c-n2-ass'),i:this.g('c-n2-imp')}, n3:{p:this.g('c-n3-prod'),a:this.g('c-n3-ass'),i:this.g('c-n3-imp')} };
                await db.collection('settings').doc('global').set(cfg); alert("Config Rede Salva!");
            },

            g(id){ return parseFloat(document.getElementById(id).value)||0 },
            fmt(v){ return v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}) },
            calc() {
                const p=this.g('i-prod'), a=this.g('i-ass'), iVal=this.g('i-imp');
                const f=(this.g('q-lav')*40)+(this.g('q-imp')*40)+(this.g('q-mon')*10)+(this.g('q-alm')*10)+(this.g('q-pes')*7);
                const t=(p*0.022)+(a*0.05)+f;
                document.getElementById('preview').innerText = this.fmt(t);
                return {t, f, p, a, i:iVal};
            },
            renderBar(l, v, m, c) {
                const p = Math.min((v/m)*100, 100).toFixed(0);
                return `<div class="glass p-3 rounded-xl"><div class="flex justify-between text-[11px] uppercase mb-1 font-bold"><span>${l}</span><span>${this.fmt(v)}</span></div><div class="bar-bg"><div class="bar-fill bg-${c}-500" style="width:${p}%"></div></div></div>`;
            },
            nav(t) { 
                ['home','metas','ranking','config','admin','team','news'].forEach(x=> { document.getElementById('tab-'+x)?.classList.add('hidden'); document.getElementById('nav-'+x)?.classList.replace('text-blue-500', 'text-gray-500'); }); 
                document.getElementById('tab-'+t).classList.remove('hidden'); document.getElementById('nav-'+t)?.classList.replace('text-gray-500', 'text-blue-500');
                if(t==='admin') this.renderAdmin();
                if(t==='team') this.renderTeam();
                if(t==='ranking') this.renderRanking();
                if(t==='config') {
                    const c = this.config;
                    document.getElementById('config-inputs-area').innerHTML = `
                        <div class="grid grid-cols-3 gap-2"><div class="col-span-3 text-[9px] font-black text-gray-500 uppercase">NÃ­vel 1</div><input type="number" id="c-n1-prod" class="input-box text-center p-2 text-xs" value="${c.n1.p}"><input type="number" id="c-n1-ass" class="input-box text-center p-2 text-xs" value="${c.n1.a}"><input type="number" id="c-n1-imp" class="input-box text-center p-2 text-xs" value="${c.n1.i}"></div>
                        <div class="grid grid-cols-3 gap-2 border-t border-gray-700 pt-4"><div class="col-span-3 text-[9px] font-black text-gray-500 uppercase">NÃ­vel 2</div><input type="number" id="c-n2-prod" class="input-box text-center p-2 text-xs" value="${c.n2.p}"><input type="number" id="c-n2-ass" class="input-box text-center p-2 text-xs" value="${c.n2.a}"><input type="number" id="c-n2-imp" class="input-box text-center p-2 text-xs" value="${c.n2.i}"></div>
                        <div class="grid grid-cols-3 gap-2 border-t border-gray-700 pt-4"><div class="col-span-3 text-[9px] font-black text-gray-500 uppercase">NÃ­vel 3</div><input type="number" id="c-n3-prod" class="input-box text-center p-2 text-xs" value="${c.n3.p}"><input type="number" id="c-n3-ass" class="input-box text-center p-2 text-xs" value="${c.n3.a}"><input type="number" id="c-n3-imp" class="input-box text-center p-2 text-xs" value="${c.n3.i}"></div>`;
                }
                if(t==='team' && this.user.r === 'manager') {
                    const s = this.storeData;
                    document.getElementById('mgr-goal-p').value = s.goal;
                    document.getElementById('mgr-val-lav').value = s.valLav;
                    document.getElementById('mgr-val-imp').value = s.valImp;
                    document.getElementById('mgr-val-mon').value = s.valMon;
                    document.getElementById('mgr-val-alm').value = s.valAlm;
                    document.getElementById('mgr-val-pes').value = s.valPes;
                }
            },
            async renderRanking() {
                const mes = new Date().toISOString().slice(0,7);
                const rData = {};
                this.allSales.forEach(s => { if(s.date.startsWith(mes)) rData[s.seller] = (rData[s.seller] || 0) + (s.v.p || 0); });
                const sorted = Object.entries(rData).sort((a,b) => b[1] - a[1]);
                const list = document.getElementById('ranking-list'); list.innerHTML = "";
                sorted.forEach((v, i) => {
                    const isMe = v[0] === this.user.id;
                    list.innerHTML += `<div class="glass p-5 rounded-[1.5rem] flex justify-between items-center border ${isMe ? 'border-blue-500 shadow-lg':'border-gray-700 opacity-60'}"><span class="font-black text-blue-400">${i+1}Âº</span><span class="font-black text-xs uppercase">${v[0]}</span><span class="font-black text-[10px] text-gray-400">${this.fmt(v[1])}</span></div>`;
                });
            },
            openModal(id){ document.getElementById(id).classList.remove('hidden'); document.getElementById(id).classList.add('flex'); },
            closeModal(id){ document.getElementById(id).classList.add('hidden'); document.getElementById(id).classList.remove('flex'); },
            logout(){ location.reload(); },
            async delOrder(id) { if(confirm("Excluir?")) { await db.collection('sales').doc(id).delete(); await this.loadInitialData(); this.closeModal('modal-detalhe'); this.renderHome(); } }
        };
        sys.init();
    </script>

    <!-- BOTÃƒO FLUTUANTE PARA ACESSAR METAS INDIVIDUAIS (ADICIONADO) -->
<div style="position: fixed; bottom: 90px; right: 20px; z-index: 9999;">
    <button onclick="window.location.href='meta-individual.html'" 
            style="background: rgba(30, 41, 59, 0.8); 
                   backdrop-filter: blur(10px); 
                   border: 1px solid rgba(59, 130, 246, 0.5); 
                   color: #60a5fa; 
                   width: 55px; 
                   height: 55px; 
                   border-radius: 50%; 
                   display: flex; 
                   align-items: center; 
                   justify-content: center; 
                   box-shadow: 0 8px 32px rgba(0,0,0,0.4);
                   cursor: pointer;
                   transition: all 0.2s active:scale-90;">
        <i class="fas fa-user-gear" style="font-size: 20px;"></i>
    </button>
</div>
</body>
</html>
