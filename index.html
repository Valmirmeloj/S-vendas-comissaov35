
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sales Force V35</title>
    
    <!-- CONFIGURA√á√ïES DE APP NATIVO -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    
    <link rel="icon" type="image/png" href="https://i.postimg.cc/MTGzyVGF/file-0000000092c471f5b7a5391ae5ba35f5-1.png">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/MTGzyVGF/file-0000000092c471f5b7a5391ae5ba35f5-1.png">

    <!-- SDKs FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        body { background-color: #0f172a; color: white; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; overflow: hidden; }
        .glass { background: #1e293b; border: 1px solid #334155; }
        .input-box { background: #020617; border: 1px solid #334155; color: white; width: 100%; padding: 12px; border-radius: 12px; outline: none; transition: 0.2s; font-size: 16px; text-transform: uppercase; }
        .input-box:focus { border-color: #3b82f6; box-shadow: 0 0 15px rgba(59, 130, 246, 0.3); }
        .hidden { display: none !important; }
        .bar-bg { background: #334155; height: 10px; border-radius: 99px; overflow: hidden; margin-top: 5px; }
        .bar-fill { height: 100%; transition: width 1s ease-in-out; }
        #loading { background: #0f172a; position: fixed; inset: 0; z-index: 9999; display: flex; flex-direction: column; items-center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #1e293b; border-top: 4px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .modal-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <!-- LOADING -->
    <div id="loading">
        <div class="spinner"></div>
        <p class="mt-4 text-[10px] text-blue-400 font-bold uppercase animate-pulse tracking-widest text-center">Sincronizando Cloud v35...</p>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed top-5 right-5 z-[9999] bg-gray-800 border-l-4 border-green-500 text-white px-6 py-4 rounded-xl shadow-2xl hidden transition-all">
        <span id="toast-msg" class="font-bold text-sm"></span>
    </div>

    <!-- LOGIN -->
    <div id="view-login" class="fixed inset-0 z-50 flex items-center justify-center p-6 bg-[#0f172a] hidden text-center">
        <div class="glass rounded-[2rem] w-full max-w-sm shadow-2xl overflow-hidden border border-gray-700">
            <div class="p-8 space-y-4">
                <!-- LOGO GIGANTE NO LOGIN -->
                <img src="https://i.postimg.cc/MTGzyVGF/file-0000000092c471f5b7a5391ae5ba35f5-1.png" class="w-48 h-48 mx-auto mb-4 rounded-2xl shadow-lg">
                <input type="text" id="login-user" class="input-box text-center font-black tracking-widest" placeholder="USU√ÅRIO">
                <input type="password" id="login-pass" class="input-box text-center font-black" placeholder="SENHA">
                <button onclick="sys.login()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-xl shadow-lg uppercase tracking-widest text-sm active:scale-95 transition-all">Acessar Sistema</button>
            </div>
            <p id="login-msg" class="text-red-400 text-[10px] pb-6 font-bold uppercase"></p>
        </div>
    </div>

    <!-- APP PRINCIPAL -->
    <div id="view-app" class="hidden flex flex-col h-full">
        <header class="bg-[#0f172a] pt-10 pb-4 px-5 flex justify-between items-end h-[100px] border-b border-gray-800 shadow-xl">
            <div class="flex items-center gap-3">
                <!-- LOGO NO HEADER -->
                <img src="https://i.postimg.cc/MTGzyVGF/file-0000000092c471f5b7a5391ae5ba35f5-1.png" class="w-16 h-16 rounded-lg border border-gray-700">
                <div>
                    <p class="text-gray-500 text-[9px] uppercase font-bold tracking-widest">Painel v35 Cloud</p>
                    <h2 class="text-xl font-black text-white uppercase leading-none" id="u-name">...</h2>
                </div>
            </div>
            <button onclick="sys.logout()" class="w-10 h-10 bg-red-500/10 rounded-xl text-red-500 border border-red-500/20 active:scale-90 transition"><i class="fas fa-power-off"></i></button>
        </header>

        <main class="flex-1 overflow-y-auto p-4 pb-32">
            
            <!-- ABA IN√çCIO -->
            <div id="tab-home">
                <div class="grid grid-cols-2 gap-3 mb-4 text-center">
                    <div class="glass p-4 rounded-2xl border-l-4 border-blue-500 shadow-lg"><p class="text-[10px] text-blue-400 font-bold uppercase tracking-widest">Vendido M√™s</p><h3 class="text-xl font-black text-white" id="d-total">R$ 0,00</h3></div>
                    <div class="glass p-4 rounded-2xl border-l-4 border-green-500 shadow-lg"><p class="text-[10px] text-green-400 font-bold uppercase tracking-widest">Monet√°rio (2.2%)</p><h3 class="text-xl font-black text-white" id="r-cprod-top">R$ 0,00</h3></div>
                </div>

                <!-- CONSULTAR FECHAMENTO -->
                <div class="glass p-4 rounded-2xl mb-4 border border-gray-700/50 shadow-lg">
                    <p class="text-[10px] text-gray-500 font-bold uppercase mb-3 text-center tracking-widest">Relat√≥rio por Data</p>
                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <input type="date" id="date-start" class="input-box p-2 text-xs text-center">
                        <input type="date" id="date-end" class="input-box p-2 text-xs text-center">
                    </div>
                    <button onclick="sys.generatePeriodReport()" class="w-full bg-blue-600/20 text-blue-400 border border-blue-500/30 py-3 rounded-xl font-black uppercase text-[10px] active:bg-blue-600 active:text-white transition-all">Buscar Dados do Per√≠odo</button>
                </div>

                <div class="mb-6">
                    <button onclick="sys.openModal('modal-pedido')" class="w-full bg-blue-600 text-white p-4 rounded-2xl flex items-center justify-center gap-3 shadow-xl active:scale-95 transition-all uppercase font-black tracking-widest"><i class="fas fa-plus-circle text-2xl"></i> Novo Pedido</button>
                </div>

                <!-- DETALHAMENTO DOS GANHOS (8 CARDS) -->
                <h3 class="text-gray-500 text-[10px] font-bold uppercase mb-2 pl-1 tracking-widest">Detalhamento dos Ganhos</h3>
                <div class="grid grid-cols-2 gap-2 mb-8">
                    <div class="glass p-3 rounded-lg"><span class="text-[9px] text-blue-400 font-bold block uppercase">Monet√°rio (2.2%)</span><span class="text-sm font-black block" id="r-cprod">R$ 0</span></div>
                    <div class="glass p-3 rounded-lg"><span class="text-[9px] text-green-400 font-bold block uppercase">Assist√™ncia</span><span class="text-sm font-black block" id="r-assist">R$ 0</span></div>
                    <div class="glass p-3 rounded-lg"><span class="text-[9px] text-purple-400 font-bold block uppercase">Vendido Imper.</span><span class="text-sm font-black block" id="r-imper">R$ 0</span></div>
                    <div class="glass p-3 rounded-lg"><span class="text-[9px] text-purple-300 font-bold block uppercase">B√¥nus Imper (40)</span><span class="text-sm font-black block" id="r-bonus-imper">R$ 0</span></div>
                    <div class="glass p-3 rounded-lg"><span class="text-[9px] text-cyan-400 font-bold block uppercase">Extra Lavagem</span><span class="text-sm font-black block" id="r-lav">R$ 0</span></div>
                    <div class="glass p-3 rounded-lg"><span class="text-[9px] text-blue-400 font-bold block uppercase">Extra Montagem</span><span class="text-sm font-black block" id="r-mon">R$ 0</span></div>
                    <div class="glass p-3 rounded-lg"><span class="text-[9px] text-pink-400 font-bold block uppercase">Extra Almofada</span><span class="text-sm font-black block" id="r-alm">R$ 0</span></div>
                    <div class="glass p-3 rounded-xl col-span-2 text-center"><span class="text-[9px] text-yellow-400 font-bold block uppercase">Extra P√©s / Guarda-roupa</span><span class="text-sm font-black block text-center" id="r-pes">R$ 0</span></div>
                </div>

                <h3 class="text-xs font-bold text-gray-500 uppercase px-1 mb-2 tracking-widest">Pedidos Recentes</h3>
                <div id="list-sales" class="space-y-2 pb-10"></div>
            </div>

            <!-- ABA NOVIDADES -->
            <div id="tab-news" class="hidden space-y-4">
                <h3 class="text-gray-500 text-[10px] font-bold uppercase mb-4 pl-1 tracking-widest text-center">Pr√≥ximas Atualiza√ß√µes</h3>
                <div class="bg-gradient-to-r from-purple-600 to-indigo-600 p-5 rounded-3xl shadow-2xl border border-white/10">
                    <div class="flex items-center gap-4">
                        <div class="bg-white/20 p-3 rounded-2xl"><i class="fas fa-wallet text-2xl text-white"></i></div>
                        <div>
                            <h4 class="font-black uppercase text-sm text-white">Gest√£o Financeira</h4>
                            <p class="text-[10px] text-purple-100 font-bold uppercase tracking-tighter">üöÄ DISPON√çVEL EM BREVE</p>
                        </div>
                    </div>
                </div>
                <div class="bg-gradient-to-r from-blue-600 to-cyan-600 p-5 rounded-3xl shadow-2xl border border-white/10">
                    <div class="flex items-center gap-4">
                        <div class="bg-white/20 p-3 rounded-2xl"><i class="fas fa-users-cog text-2xl text-white"></i></div>
                        <div>
                            <h4 class="font-black uppercase text-sm text-white">Gest√£o Gerencial</h4>
                            <p class="text-[10px] text-blue-100 font-bold uppercase tracking-tighter">üöÄ DISPON√çVEL EM BREVE</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB METAS -->
            <div id="tab-metas" class="hidden space-y-6">
                <div class="bg-gradient-to-r from-purple-900 to-indigo-900 p-6 rounded-[2rem] border border-purple-500/30 text-center shadow-2xl">
                    <p class="text-purple-300 text-[10px] font-bold uppercase tracking-widest">B√¥nus Performance Estimado</p>
                    <h2 class="text-4xl font-black my-2" id="m-bonus">R$ 0,00</h2>
                    <span id="m-badge" class="bg-black/30 px-4 py-1 rounded-full text-[10px] font-bold text-yellow-400 uppercase tracking-widest">N√≠vel 0</span>
                </div>
                <div id="goals-bars" class="space-y-4"></div>
            </div>

            <!-- TAB AJUSTES (S√ì ADMIN) -->
            <div id="tab-config" class="hidden space-y-4">
                <div class="glass p-6 rounded-[2rem] border-l-4 border-yellow-500 shadow-xl text-center">
                    <h3 class="text-yellow-500 font-black text-xs uppercase mb-6 tracking-widest uppercase">Metas Globais Cloud</h3>
                    <div class="space-y-6" id="config-inputs">
                        <div class="grid grid-cols-3 gap-2 text-center">
                            <div class="col-span-3 text-[9px] font-black text-gray-500 uppercase border-b border-gray-700 pb-1">N√≠vel 1 (0.3%)</div>
                            <input type="number" id="c-n1-prod" class="input-box text-center p-2 text-xs" placeholder="Venda">
                            <input type="number" id="c-n1-ass" class="input-box text-center p-2 text-xs" placeholder="Assis">
                            <input type="number" id="c-n1-imp" class="input-box text-center p-2 text-xs" placeholder="Imper">
                        </div>
                        <div class="grid grid-cols-3 gap-2 border-t border-gray-700 pt-4 text-center">
                            <div class="col-span-3 text-[9px] font-black text-gray-500 uppercase border-b border-gray-700 pb-1">N√≠vel 2 (0.6%)</div>
                            <input type="number" id="c-n2-prod" class="input-box text-center p-2 text-xs" placeholder="Venda">
                            <input type="number" id="c-n2-ass" class="input-box text-center p-2 text-xs" placeholder="Assis">
                            <input type="number" id="c-n2-imp" class="input-box text-center p-2 text-xs" placeholder="Imper">
                        </div>
                        <div class="grid grid-cols-3 gap-2 border-t border-gray-700 pt-4 text-center">
                            <div class="col-span-3 text-[9px] font-black text-gray-500 uppercase border-b border-gray-700 pb-1">N√≠vel 3 (1.1%)</div>
                            <input type="number" id="c-n3-prod" class="input-box text-center p-2 text-xs" placeholder="Venda">
                            <input type="number" id="c-n3-ass" class="input-box text-center p-2 text-xs" placeholder="Assis">
                            <input type="number" id="c-n3-imp" class="input-box text-center p-2 text-xs" placeholder="Imper">
                        </div>
                    </div>
                </div>
                <button onclick="sys.saveConfig()" class="w-full bg-blue-600 font-black py-4 rounded-xl shadow-lg uppercase text-xs tracking-widest active:scale-95 transition-all">Salvar Metas na Nuvem</button>
            </div>

            <!-- TAB ADMIN (MENSALIDADES COM NOVAS OP√á√ïES) -->
            <div id="tab-admin" class="hidden space-y-6 pb-32 text-center">
                <div class="glass p-6 rounded-[2rem] shadow-xl border border-gray-700">
                    <h3 class="font-black text-xs uppercase mb-4 text-gray-300 tracking-widest uppercase">Novo Vendedor</h3>
                    <div class="space-y-3">
                        <input type="text" id="adm-new-user" class="input-box uppercase" placeholder="NOME">
                        <input type="password" id="adm-new-pass" class="input-box" placeholder="SENHA">
                        <button onclick="sys.adminCreateUser()" class="w-full bg-blue-600 font-black py-4 rounded-xl uppercase text-xs tracking-widest shadow-lg">Criar Acesso</button>
                    </div>
                </div>
                <h3 class="text-xs font-black text-blue-400 uppercase tracking-widest ml-1 mt-6 text-left">Gest√£o de Mensalidades</h3>
                <div id="adm-user-list" class="space-y-3"></div>
            </div>
        </main>

        <nav class="glass fixed bottom-0 w-full z-40 flex justify-around items-center h-[75px] border-t border-gray-800 text-gray-500">
            <button onclick="sys.nav('home')" id="nav-home" class="flex-1 flex flex-col items-center gap-1 text-blue-500 transition-all"><i class="fas fa-home text-lg"></i><span class="text-[10px] font-bold">In√≠cio</span></button>
            <button onclick="sys.nav('news')" id="nav-news" class="flex-1 flex flex-col items-center gap-1 transition-all"><i class="fas fa-star text-lg"></i><span class="text-[10px] font-bold">Novidades</span></button>
            <button onclick="sys.nav('metas')" id="nav-metas" class="flex-1 flex flex-col items-center gap-1 transition-all"><i class="fas fa-trophy text-lg"></i><span class="text-[10px] font-bold">Metas</span></button>
            <button onclick="sys.nav('config')" id="nav-config" class="hidden flex-1 flex flex-col items-center gap-1 transition-all"><i class="fas fa-sliders-h text-lg"></i><span class="text-[10px] font-bold">Ajustes</span></button>
            <button onclick="sys.nav('admin')" id="nav-admin" class="hidden flex-1 flex flex-col items-center gap-1 transition-all"><i class="fas fa-users-cog text-lg"></i><span class="text-[10px] font-bold">Admin</span></button>
        </nav>
    </div>

    <!-- MODAL NOVO PEDIDO -->
    <div id="modal-pedido" class="fixed inset-0 z-[100] hidden items-end justify-center bg-black/80 backdrop-blur-sm">
        <div class="bg-[#1e293b] w-full max-w-md rounded-t-[2.5rem] p-8 modal-up border-t border-blue-500/30 shadow-2xl">
            <div class="flex justify-between items-center mb-6"><h2 class="uppercase font-black text-blue-400 tracking-tighter text-lg">Lan√ßar Novo Pedido</h2><button onclick="sys.closeModal('modal-pedido')"><i class="fas fa-times"></i></button></div>
            <div class="space-y-4">
                <input type="tel" id="i-ord" placeholder="N¬∫ DO PEDIDO" class="input-box text-center font-bold text-xl border-blue-500/30">
                <div class="grid grid-cols-3 gap-2 text-center font-bold">
                    <div><label class="text-[9px] uppercase">Venda</label><input type="number" id="i-prod" class="input-box text-center p-2" oninput="sys.calc()"></div>
                    <div><label class="text-[9px] uppercase">Assis</label><input type="number" id="i-ass" class="input-box text-center p-2" oninput="sys.calc()"></div>
                    <div><label class="text-[9px] uppercase">Imper</label><input type="number" id="i-imp" class="input-box text-center p-2" oninput="sys.calc()"></div>
                </div>
                <div class="grid grid-cols-2 gap-2 text-[10px] bg-black/20 p-4 rounded-xl border border-gray-700 font-bold uppercase tracking-tighter">
                    <div class="flex justify-between items-center">Lavagem (40)<input id="q-lav" type="number" class="w-8 bg-blue-600 rounded text-center" oninput="sys.calc()"></div>
                    <div class="flex justify-between items-center">Imper (40)<input id="q-imp" type="number" class="w-8 bg-blue-600 rounded text-center" oninput="sys.calc()"></div>
                    <div class="flex justify-between items-center">Montagem (10)<input id="q-mon" type="number" class="w-8 bg-blue-600 rounded text-center" oninput="sys.calc()"></div>
                    <div class="flex justify-between items-center">Almofada (10)<input id="q-alm" type="number" class="w-8 bg-blue-600 rounded text-center" oninput="sys.calc()"></div>
                    <div class="flex justify-between items-center col-span-2 pt-1 border-t border-gray-700">P√©s/Guarda-roupa (7)<input id="q-pes" type="number" class="w-8 bg-blue-600 rounded text-center" oninput="sys.calc()"></div>
                </div>
                <div class="flex justify-between font-black text-green-400 pt-2 uppercase text-[10px]"><span>Estimativa Comiss√£o:</span><span id="preview">R$ 0,00</span></div>
                <button onclick="sys.saveOrder()" class="w-full bg-blue-600 py-4 rounded-xl font-black uppercase shadow-lg tracking-widest transition active:scale-95">Salvar na Nuvem</button>
            </div>
        </div>
    </div>

    <!-- MODAL DETALHE -->
    <div id="modal-detalhe" class="fixed inset-0 z-[110] hidden items-center justify-center bg-black/90 p-4 backdrop-blur-sm">
        <div class="bg-[#1e293b] w-full max-w-sm rounded-[2rem] border border-gray-700 shadow-2xl overflow-hidden">
            <div id="det-corpo" class="p-6 text-sm"></div>
            <div class="p-4 bg-gray-900 flex gap-2 border-t border-gray-800">
                <button id="det-btn-del" class="flex-1 bg-red-600/10 text-red-500 font-bold py-3 rounded-xl border border-red-500/20 uppercase text-[10px]">Excluir</button>
                <button onclick="sys.closeModal('modal-detalhe')" class="flex-1 bg-gray-700 font-bold py-3 rounded-xl uppercase text-[10px]">Voltar</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAZ6Zp-XRhmJaqyrA806YxGAYo3TyFttpQ",
            authDomain: "b-dados-sistema.firebaseapp.com",
            projectId: "b-dados-sistema",
            storageBucket: "b-dados-sistema.firebasestorage.app",
            messagingSenderId: "725143488446",
            appId: "1:725143488446:web:ab7178929e9c9b8dcf9bef"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const sys = {
            user: null, allSales: [], config: {},

            async init() {
                const saved = localStorage.getItem('v35_session');
                if (saved) {
                    this.user = JSON.parse(saved);
                    this.afterLogin();
                } else {
                    document.getElementById('loading').style.display='none';
                    document.getElementById('view-login').classList.remove('hidden');
                }
                
                try {
                    const conf = await db.collection('settings').doc('global').get();
                    this.config = conf.exists ? conf.data() : { n1:{p:70000,a:720,i:720}, n2:{p:80000,a:2200,i:2160}, n3:{p:96000,a:3000,i:3000} };
                } catch(e) {}
            },

            async login() {
                const u = document.getElementById('login-user').value.toLowerCase().trim();
                const p = document.getElementById('login-pass').value.trim();
                if(!u || !p) return;
                document.getElementById('loading').style.display='flex';
                try {
                    if (u === "admin" && p === "master77") {
                        await db.collection('users').doc(u).set({ p:"master77", r:"admin", b:false, d:Date.now(), exp:Date.now()+(3650*86400000) });
                    }
                    const uDoc = await db.collection('users').doc(u).get();
                    if(!uDoc.exists || uDoc.data().p !== p) throw new Error("Acesso negado.");
                    const data = uDoc.data();
                    if(data.b) throw new Error("Bloqueado.");
                    if(data.r !== 'admin' && Date.now() > data.exp) throw new Error("Acesso expirado.");

                    this.user = { id: u, ...data };
                    localStorage.setItem('v35_session', JSON.stringify(this.user));
                    this.afterLogin();
                } catch(e) { document.getElementById('login-msg').innerText = e.message; }
                document.getElementById('loading').style.display='none';
            },

            async afterLogin() {
                if(this.user.r === 'admin') {
                    document.getElementById('nav-admin').classList.remove('hidden');
                    document.getElementById('nav-config').classList.remove('hidden');
                }
                document.getElementById('u-name').innerText = this.user.id;
                await this.loadInitialData();
                document.getElementById('view-login').classList.add('hidden');
                document.getElementById('view-app').classList.remove('hidden');
                document.getElementById('loading').style.display='none';
                this.renderHome();
            },

            async loadInitialData() {
                const confDoc = await db.collection('settings').doc('global').get();
                this.config = confDoc.exists ? confDoc.data() : { n1:{p:70000,a:720,i:720}, n2:{p:80000,a:2200,i:2160}, n3:{p:96000,a:3000,i:3000} };
                await this.loadAllSales();
            },

            async loadAllSales() {
                const snap = await db.collection('sales').where('seller','==',this.user.id).get();
                this.allSales = snap.docs.map(d => ({id:d.id, ...d.data()})).sort((a,b) => b.date.localeCompare(a.date));
            },

            renderHome() {
                const mesAtualStr = new Date().toISOString().slice(0,7);
                const filtrados = this.allSales.filter(s => s.date.startsWith(mesAtualStr));
                let t = {p:0, a:0, i:0, f:0, lav:0, mon:0, pes:0, alm:0, impBonus:0};
                filtrados.forEach(s => {
                    t.p += (s.v.p || 0); t.a += (s.v.a || 0); t.i += (s.v.i || 0); t.f += (s.bonus || 0);
                    t.lav += (s.q?.lav||0)*40; t.mon += (s.q?.mon||0)*10;
                    t.pes += (s.q?.pes||0)*7; t.alm += (s.q?.alm||0)*10;
                    t.impBonus += (s.q?.imp||0)*40;
                });
                const C = this.config;
                let pct = (t.p>=C.n3.p && t.a>=C.n3.a && t.i>=C.n3.i) ? 0.011 : (t.p>=C.n2.p && t.a>=C.n2.a && t.i>=C.n2.i) ? 0.006 : (t.p>=C.n1.p && t.a>=C.n1.a && t.i>=C.n1.i) ? 0.003 : 0;
                const aPct = (t.p>=C.n2.p && t.a>=C.n2.a && t.i>=C.n2.i) ? 0.10 : 0.05;

                document.getElementById('d-total').innerText = this.fmt(t.p);
                document.getElementById('r-cprod-top').innerText = this.fmt(t.p * 0.022);
                
                document.getElementById('r-cprod').innerText = this.fmt(t.p * 0.022);
                document.getElementById('r-assist').innerText = this.fmt(t.a * aPct);
                document.getElementById('r-imper').innerText = this.fmt(t.i);
                document.getElementById('r-bonus-imper').innerText = this.fmt(t.impBonus);
                document.getElementById('r-lav').innerText = this.fmt(t.lav);
                document.getElementById('r-mon').innerText = this.fmt(t.mon);
                document.getElementById('r-pes').innerText = this.fmt(t.pes);
                document.getElementById('r-alm').innerText = this.fmt(t.alm);
                document.getElementById('m-bonus').innerText = this.fmt(t.p * pct);
                document.getElementById('m-badge').innerText = pct === 0.011 ? "N√≠vel 3 üî•" : pct === 0.006 ? "N√≠vel 2 ü•à" : pct === 0.003 ? "N√≠vel 1 ü•â" : "N√≠vel 0";

                document.getElementById('goals-bars').innerHTML = `
                    ${this.renderBar("Produto", t.p, C.n2.p, "blue")}
                    ${this.renderBar("Assist√™ncia", t.a, C.n2.a, "green")}
                    ${this.renderBar("Impermeab.", t.i, C.n2.i, "purple")}
                `;

                const list = document.getElementById('list-sales'); list.innerHTML = "";
                filtrados.slice(0, 15).forEach(s => {
                    list.innerHTML += `<div onclick="sys.verDetalhe('${s.id}')" class="glass p-4 mb-2 rounded-xl flex justify-between items-center active:scale-95 transition"><div><span class="text-[10px] text-gray-500 uppercase">${new Date(s.date).toLocaleDateString()}</span><div class="font-bold">#${s.order}</div></div><div class="text-green-400 font-black">+ ${this.fmt(s.preview)}</div></div>`;
                });
            },

            generatePeriodReport() {
                const dStart = document.getElementById('date-start').value;
                const dEnd = document.getElementById('date-end').value;
                if(!dStart || !dEnd) return alert("Datas!");
                const start = new Date(dStart + "T00:00:00");
                const end = new Date(dEnd + "T23:59:59");
                const filtrados = this.allSales.filter(s => { const d = new Date(s.date); return d >= start && d <= end; });
                let t = {p:0, a:0, i:0, f:0, qtd:0};
                filtrados.forEach(s => { t.qtd++; t.p += (s.v.p || 0); t.a += (s.v.a || 0); t.i += (s.v.i || 0); t.f += (s.bonus || 0); });
                const C = this.config;
                let pct = (t.p>=C.n3.p && t.a>=C.n3.a && t.i>=C.n3.i) ? 0.011 : (t.p>=C.n2.p && t.a>=C.n2.a && t.i>=C.n2.i) ? 0.006 : (t.p>=C.n1.p && t.a>=C.n1.a && t.i>=C.n1.i) ? 0.003 : 0;
                const aPct = (t.p>=C.n2.p && t.a>=C.n2.a && t.i>=C.n2.i) ? 0.10 : 0.05;
                const totalFinal = (t.p * 0.022) + (t.a * aPct) + t.f + (t.p * pct);
                document.getElementById('period-details-body').innerHTML = `<div class="space-y-3 text-center uppercase font-bold text-gray-400"><div class="flex justify-between border-b border-gray-700 pb-1 text-[10px]"><span>Total Pedidos:</span><b>${t.qtd}</b></div><div class="flex justify-between border-b border-gray-700 pb-1 text-[10px]"><span>Venda Prod:</span><b>${this.fmt(t.p)}</b></div><div class="pt-4 text-xs uppercase text-gray-500 font-black">Total no Per√≠odo</div><div class="text-3xl font-black text-blue-400">${this.fmt(totalFinal)}</div></div>`;
                this.openModal('modal-periodo');
            },

            verDetalhe(id) {
                const s = this.allSales.find(x => x.id === id);
                if(!s) return;
                document.getElementById('det-corpo').innerHTML = `<h3 class="font-black text-center text-xl mb-4 text-white uppercase tracking-widest font-black">Pedido #${s.order}</h3><div class="space-y-3 font-bold uppercase"><div class="flex justify-between border-b border-gray-700 pb-1 text-[10px] text-gray-400"><span>Prod:</span><b class="text-white">${this.fmt(s.v.p)}</b></div><div class="flex justify-between border-b border-gray-700 pb-1 text-[10px] text-gray-400"><span>Assis:</span><b class="text-white">${this.fmt(s.v.a)}</b></div><div class="bg-black/30 p-3 rounded-xl mt-4 grid grid-cols-2 gap-2 text-[10px] text-gray-500 text-center uppercase font-black"><span>Lav: ${s.q?.lav||0}</span><span>Mon: ${s.q?.mon||0}</span><span>Alm: ${s.q?.alm||0}</span><span>P√©s/G.Roup: ${s.q?.pes||0}</span></div><div class="text-center pt-6 text-2xl font-black text-green-400 tracking-tighter">${this.fmt(s.preview)}</div></div>`;
                document.getElementById('det-btn-del').onclick = () => this.delOrder(id);
                this.openModal('modal-detalhe');
            },

            async adminCreateUser() {
                const n = document.getElementById('adm-new-user').value.toLowerCase().trim();
                const p = document.getElementById('adm-new-pass').value;
                if(!n || !p) return;
                await db.collection('users').doc(n).set({ p, r:'seller', b:false, d:Date.now(), exp: Date.now() + (7*86400000) });
                this.renderAdmin();
            },

            async renderAdmin() {
                const snap = await db.collection('users').get();
                const list = document.getElementById('adm-user-list'); list.innerHTML = "";
                snap.forEach(doc => {
                    const u = doc.data(); if(u.r==='admin') return;
                    const dias = Math.max(0, Math.ceil((u.exp - Date.now()) / 86400000));
                    list.innerHTML += `<div class="glass p-4 rounded-[1.5rem] border border-gray-700 mb-3 shadow-xl text-left"><div class="flex justify-between items-center mb-3"><span class="font-black uppercase text-sm">${doc.id} ${u.b?'üî¥':'üü¢'}</span><span class="text-blue-400 font-bold text-xs">${dias}d</span></div><div class="grid grid-cols-2 gap-2"><select id="months-${doc.id}" class="input-box p-1 text-xs bg-gray-900 border-gray-600 font-black"><option value="1">+ 1 M√™s</option><option value="3">+ 3 Meses</option><option value="6">+ 6 Meses</option><option value="12">+ 1 Ano</option></select><button onclick="sys.adminAddMonths('${doc.id}')" class="bg-green-600 rounded-lg text-[10px] font-black uppercase py-1">Renovar</button><button onclick="sys.adminToggle('${doc.id}')" class="bg-gray-700 rounded-lg text-[10px] font-black uppercase py-2">${u.b?'Ativar':'Bloquear'}</button><button onclick="sys.adminDelUser('${doc.id}')" class="bg-red-900/30 text-red-500 rounded-lg text-[10px] font-black uppercase py-2">Apagar</button></div></div>`;
                });
            },

            async adminAddMonths(id) {
                const m = parseInt(document.getElementById(`months-${id}`).value);
                const uDoc = await db.collection('users').doc(id).get();
                const base = uDoc.data().exp > Date.now() ? uDoc.data().exp : Date.now();
                await db.collection('users').doc(id).update({ exp: base + (m * 30 * 86400000) });
                this.renderAdmin();
            },

            async adminToggle(id) {
                const uDoc = await db.collection('users').doc(id).get();
                await db.collection('users').doc(id).update({ b: !uDoc.data().b });
                this.renderAdmin();
            },
            
            async adminDelUser(id) { if(confirm("Apagar?")) { await db.collection('users').doc(id).delete(); this.renderAdmin(); } },

            async saveOrder() {
                const ord = document.getElementById('i-ord').value;
                if(!ord) return alert("N¬∫?");
                const c = this.calc();
                document.getElementById('loading').style.display='flex';
                await db.collection('sales').add({ seller: this.user.id, order: ord, v: {p:c.p, a:c.a, i:c.i}, bonus: c.f, preview: c.t, date: new Date().toISOString(), q: {lav:this.g('q-lav'), imp:this.g('q-imp'), mon:this.g('q-mon'), alm:this.g('q-alm'), pes:this.g('q-pes')} });
                await this.loadAllSales(); this.closeModal('modal-pedido'); document.getElementById('loading').style.display='none'; this.renderHome();
                this.toast("Sucesso!");
            },

            async saveConfig() {
                const cfg = { n1:{p:this.g('c-n1-prod'), a:this.g('c-n1-ass'), i:this.g('c-n1-imp')}, n2:{p:this.g('c-n2-prod'), a:this.g('c-n2-ass'), i:this.g('c-n2-imp')}, n3:{p:this.g('c-n3-prod'), a:this.g('c-n3-ass'), i:this.g('c-n3-imp')} };
                await db.collection('settings').doc('global').set(cfg); this.config = cfg; alert("Config Salva!");
            },

            logout(){ localStorage.removeItem('v35_session'); location.reload(); },
            g(id){ return parseFloat(document.getElementById(id).value)||0 },
            fmt(v){ return v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}) },
            calc() {
                const p=this.g('i-prod'), a=this.g('i-ass');
                const f=(this.g('q-lav')*40)+(this.g('q-imp')*40)+(this.g('q-mon')*10)+(this.g('q-alm')*10)+(this.g('q-pes')*7);
                const t=(p*0.022)+(a*0.05)+f;
                document.getElementById('preview').innerText = this.fmt(t);
                return {t, f, p, a, i:this.g('i-imp')};
            },
            renderBar(l, v, m, c) {
                const p = Math.min((v/m)*100, 100).toFixed(0);
                return `<div class="glass p-3 rounded-xl shadow-md"><div class="flex justify-between text-[10px] uppercase mb-1 font-bold"><span class="text-${c}-400">${l}</span><span>${this.fmt(v)}</span></div><div class="bar-bg"><div class="bar-fill bg-${c}-500" style="width:${p}%"></div></div></div>`;
            },
            nav(t) { 
                ['home','news','metas','config','admin'].forEach(x=> { document.getElementById('tab-'+x).classList.add('hidden'); document.getElementById('nav-'+x)?.classList.replace('text-blue-500', 'text-gray-500'); }); 
                document.getElementById('tab-'+t).classList.remove('hidden'); document.getElementById('nav-'+t)?.classList.replace('text-gray-500', 'text-blue-500');
                if(t==='admin') this.renderAdmin();
                if(t==='config') {
                    const c = this.config;
                    ['n1','n2','n3'].forEach(n => { document.getElementById(`c-${n}-prod`).value = c[n].p; document.getElementById(`c-${n}-ass`).value = c[n].a; document.getElementById(`c-${n}-imp`).value = c[n].i; });
                }
            },
            openModal(id){ document.getElementById(id).classList.remove('hidden'); document.getElementById(id).classList.add('flex'); },
            closeModal(id){ document.getElementById(id).classList.add('hidden'); document.getElementById(id).classList.remove('flex'); },
            async delOrder(id){ if(confirm("Apagar?")){ await db.collection('sales').doc(id).delete(); await this.loadAllSales(); this.renderHome(); this.closeModal('modal-detalhe'); } },
            toast(m){ const t=document.getElementById('toast'); document.getElementById('toast-msg').innerText=m; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'),3000); }
        };
        sys.init();
    </script>
</body>
</html>
