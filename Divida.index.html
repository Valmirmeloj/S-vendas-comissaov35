
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gest√£o Financeira V35 - Contas Pro</title>
    
    <!-- SDKs FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- ESTILOS E FONTES -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        /* CSS ORIGINAL DO SEU CONTAS PRO V74 (ADAPTADO) */
        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background: #0f172a; color: #f8fafc; overflow-x: hidden; }
        body.notion-mode { background: #ffffff; color: #37352f; }
        .app-container { width: 100%; min-height: 100vh; padding: 110px 16px 32px 16px; position: relative; }
        
        .top-actions-bar { position: fixed; top: 0; left: 0; right: 0; background: rgba(15, 23, 42, 0.98); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(139, 92, 246, 0.3); padding: 12px; z-index: 1000; display: flex; justify-content: space-between; align-items: center; gap: 8px; flex-wrap: wrap; }
        body.notion-mode .top-actions-bar { background: #fff; border-bottom: 1px solid #eee; }

        .app-logo { font-size: 18px; font-weight: 800; background: linear-gradient(135deg, #8b5cf6 0%, #06b6d4 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .month-selector-compact { display: flex; align-items: center; gap: 4px; background: rgba(139, 92, 246, 0.1); padding: 4px 8px; border-radius: 10px; }
        
        .glass { background: #1e293b; border: 1px solid #334155; border-radius: 16px; padding: 16px; }
        body.notion-mode .glass { background: #fff; border-color: #eee; color: #333; }

        .stat-card-compact { background: linear-gradient(135deg, #1e293b 0%, #334155 100%); border-radius: 12px; padding: 12px; border: 1px solid rgba(139, 92, 246, 0.2); }
        body.notion-mode .stat-card-compact { background: #f9f9f9; border-color: #ddd; }

        .kanban-board { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin-top: 20px; }
        .kanban-column { background: rgba(30, 41, 59, 0.5); border-radius: 16px; padding: 12px; border: 1px solid rgba(139, 92, 246, 0.1); min-height: 200px; }
        .kanban-card { background: #1e293b; border-radius: 12px; padding: 12px; border: 1px solid #334155; margin-bottom: 12px; }
        
        .input-box { background: rgba(15, 23, 42, 0.5); border: 1px solid #334155; color: white; padding: 10px; border-radius: 10px; width: 100%; outline: none; }
        body.notion-mode .input-box { background: #fff; border-color: #ccc; color: #333; }

        .tab-btn { padding: 10px 16px; font-weight: 700; color: #94a3b8; border-bottom: 2px solid transparent; }
        .tab-btn.active { color: #8b5cf6; border-bottom-color: #8b5cf6; }
        .hidden { display: none !important; }
        #loading-screen { position: fixed; inset: 0; background: #0f172a; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="w-12 h-12 border-4 border-purple-500 border-t-transparent rounded-full animate-spin"></div>
        <p class="mt-4 text-purple-400 font-bold uppercase tracking-widest text-[10px]">Sincronizando Finan√ßas v35...</p>
    </div>

    <!-- HEADER COMPACTO -->
    <div class="top-actions-bar">
        <div class="flex items-center gap-4">
            <button onclick="location.href='index.html'" class="text-gray-400 hover:text-white"><i class="fas fa-arrow-left text-xl"></i></button>
            <div class="app-logo">üí∞ Contas Pro</div>
            <div class="month-selector-compact">
                <button onclick="fin.changeMonth(-1)" class="text-purple-500 font-bold">‚óÄ</button>
                <div id="display-month" class="text-xs font-bold min-width-[80px] text-center uppercase">Janeiro 2024</div>
                <button onclick="fin.changeMonth(1)" class="text-purple-500 font-bold">‚ñ∂</button>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="fin.toggleViewMode()" class="bg-gray-800 p-2 rounded-lg text-xs font-bold"><span id="mode-icon">üåô</span></button>
            <button onclick="fin.exportCSV()" class="bg-blue-600 px-3 py-2 rounded-lg text-[10px] font-black uppercase">Exportar</button>
        </div>
    </div>

    <div class="app-container">
        <!-- RESUMO -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6" id="dashboard-stats">
            <!-- Gerado via JS -->
        </div>

        <!-- GERENCIAR SALDO -->
        <div class="glass mb-6">
            <h3 class="text-xs font-bold uppercase text-purple-400 mb-3"><i class="fas fa-wallet mr-2"></i>Gerenciar Saldo</h3>
            <div class="flex gap-2 flex-wrap">
                <input type="number" id="input-saldo" class="input-box flex-1" placeholder="Valor R$">
                <button onclick="fin.addSaldo()" class="bg-green-600 px-4 py-2 rounded-xl font-bold text-xs">Adicionar</button>
                <button onclick="fin.distribuirSaldo()" class="bg-purple-600 px-4 py-2 rounded-xl font-bold text-xs">Distribuir</button>
            </div>
            <div id="area-saldo-atual" class="mt-3 text-center hidden">
                <p class="text-[10px] text-gray-500 uppercase font-bold">Saldo Dispon√≠vel para Aloca√ß√£o</p>
                <h2 id="val-saldo-disponivel" class="text-2xl font-black text-green-400">R$ 0,00</h2>
            </div>
        </div>

        <!-- ADD NOVA CONTA -->
        <div class="glass mb-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xs font-bold uppercase text-blue-400">‚ûï Nova Conta / Parcela</h3>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
                <select id="add-icon" class="input-box">
                    <option value="üí°">üí° Luz</option><option value="üíß">üíß √Ågua</option>
                    <option value="üè†">üè† Aluguel</option><option value="üçî">üçî Alimenta√ß√£o</option>
                    <option value="üí≥">üí≥ Cart√£o</option><option value="üí∞">üí∞ Outros</option>
                </select>
                <input type="text" id="add-nome" class="input-box" placeholder="Nome da Conta">
                <input type="number" id="add-valor" class="input-box" placeholder="Valor Total R$">
                <input type="date" id="add-data" class="input-box">
                <input type="number" id="add-parcelas" class="input-box" placeholder="Parcelas" value="1">
                <button onclick="fin.salvarConta()" class="bg-blue-600 col-span-full py-3 rounded-xl font-black uppercase text-xs shadow-lg">Salvar Lan√ßamento</button>
            </div>
        </div>

        <!-- TABS -->
        <div class="flex gap-4 border-b border-gray-800 mb-6">
            <button onclick="fin.setTab('kanban')" id="btn-tab-kanban" class="tab-btn active">QUADRO KANBAN</button>
            <button onclick="fin.setTab('graficos')" id="btn-tab-graficos" class="tab-btn">GR√ÅFICOS</button>
        </div>

        <!-- CONTE√öDO KANBAN -->
        <div id="tab-kanban">
            <div class="kanban-board">
                <div class="kanban-column">
                    <h4 class="text-[10px] font-black uppercase text-red-400 mb-4 border-b border-red-900/30 pb-2">üî¥ A Pagar</h4>
                    <div id="col-pending" class="space-y-3"></div>
                </div>
                <div class="kanban-column">
                    <h4 class="text-[10px] font-black uppercase text-yellow-400 mb-4 border-b border-yellow-900/30 pb-2">üü° Em Progresso</h4>
                    <div id="col-progress" class="space-y-3"></div>
                </div>
                <div class="kanban-column">
                    <h4 class="text-[10px] font-black uppercase text-green-400 mb-4 border-b border-green-900/30 pb-2">üü¢ Pagas</h4>
                    <div id="col-completed" class="space-y-3"></div>
                </div>
            </div>
        </div>

        <!-- CONTE√öDO GRAFICOS -->
        <div id="tab-graficos" class="hidden">
            <div class="glass">
                <canvas id="meuGrafico"></canvas>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURA√á√ÉO FIREBASE (MESMA DO SEU APP DE VENDAS)
        const firebaseConfig = {
            apiKey: "AIzaSyAZ6Zp-XRhmJaqyrA806YxGAYo3TyFttpQ",
            authDomain: "b-dados-sistema.firebaseapp.com",
            projectId: "b-dados-sistema",
            storageBucket: "b-dados-sistema.firebasestorage.app",
            messagingSenderId: "725143488446",
            appId: "1:725143488446:web:ab7178929e9c9b8dcf9bef"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const fin = {
            user: null, currentMonth: new Date(), allData: [],
            
            async init() {
                const session = localStorage.getItem('v35_session');
                if(!session) { alert("Acesso negado. Logue pelo app de vendas."); location.href='index.html'; return; }
                this.user = JSON.parse(session);
                this.renderMonth();
                await this.fetchData();
                document.getElementById('loading-screen').classList.add('hidden');
            },

            async fetchData() {
                const monthKey = this.getMonthKey(this.currentMonth);
                const snap = await db.collection('debts').where('seller', '==', this.user.id).where('monthKey', '==', monthKey).get();
                this.allData = snap.docs.map(d => ({id: d.id, ...d.data()}));
                this.renderAll();
            },

            renderAll() {
                this.renderDashboard();
                this.renderKanban();
                this.renderSaldo();
                if(!document.getElementById('tab-graficos').classList.contains('hidden')) this.renderChart();
            },

            renderDashboard() {
                const regular = this.allData.filter(x => !x.isBalance);
                const total = regular.reduce((s,v) => s + v.valor, 0);
                const pago = regular.reduce((s,v) => s + (v.pago || 0), 0);
                const pendente = total - pago;
                const perc = total > 0 ? ((pago/total)*100).toFixed(0) : 0;

                document.getElementById('dashboard-stats').innerHTML = `
                    <div class="stat-card-compact"><p class="text-[9px] text-gray-400 font-bold uppercase">Total M√™s</p><h3 class="text-lg font-black">${this.fmt(total)}</h3></div>
                    <div class="stat-card-compact"><p class="text-[9px] text-green-400 font-bold uppercase">J√° Pago</p><h3 class="text-lg font-black">${this.fmt(pago)}</h3></div>
                    <div class="stat-card-compact"><p class="text-[9px] text-red-400 font-bold uppercase">Pendente</p><h3 class="text-lg font-black">${this.fmt(pendente)}</h3></div>
                    <div class="stat-card-compact"><p class="text-[9px] text-purple-400 font-bold uppercase">Progresso</p><h3 class="text-lg font-black">${perc}%</h3></div>
                `;
            },

            renderKanban() {
                const cols = {pending: '', progress: '', completed: ''};
                this.allData.filter(x => !x.isBalance).forEach(item => {
                    const perc = (item.pago / item.valor) * 100;
                    const status = perc >= 100 ? 'completed' : perc > 0 ? 'progress' : 'pending';
                    cols[status] += `
                        <div class="kanban-card">
                            <div class="flex justify-between items-start mb-2">
                                <div class="text-xs font-bold uppercase">${item.icon} ${item.nome}</div>
                                <div class="text-xs font-black">${this.fmt(item.valor)}</div>
                            </div>
                            <div class="w-full bg-gray-900 h-2 rounded-full overflow-hidden mb-2">
                                <div class="bg-blue-500 h-full" style="width: ${perc}%"></div>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-[9px] text-gray-500 font-bold">VENC: ${item.data.split('-').reverse().join('/')}</span>
                                <div class="flex gap-2">
                                    <button onclick="fin.excluir('${item.id}')" class="text-red-500 text-[10px] underline">Apagar</button>
                                    <button onclick="fin.quitar('${item.id}')" class="bg-blue-600 px-2 py-1 rounded text-[10px] font-bold">Quitar</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                document.getElementById('col-pending').innerHTML = cols.pending || '<p class="text-center text-gray-700 text-[10px] mt-4">Vazio</p>';
                document.getElementById('col-progress').innerHTML = cols.progress || '<p class="text-center text-gray-700 text-[10px] mt-4">Vazio</p>';
                document.getElementById('col-completed').innerHTML = cols.completed || '<p class="text-center text-gray-700 text-[10px] mt-4">Vazio</p>';
            },

            async salvarConta() {
                const nome = document.getElementById('add-nome').value.toUpperCase();
                const valor = parseFloat(document.getElementById('add-valor').value);
                const icon = document.getElementById('add-icon').value;
                const data = document.getElementById('add-data').value;
                const parcelas = parseInt(document.getElementById('add-parcelas').value) || 1;

                if(!nome || !valor || !data) return alert("Preencha tudo!");

                document.getElementById('loading-screen').classList.remove('hidden');
                
                for(let i=0; i<parcelas; i++) {
                    const dataParcela = new Date(data + 'T12:00:00');
                    dataParcela.setMonth(dataParcela.getMonth() + i);
                    const monthKey = this.getMonthKey(dataParcela);
                    
                    await db.collection('debts').add({
                        seller: this.user.id,
                        nome: parcelas > 1 ? `${nome} (${i+1}/${parcelas})` : nome,
                        valor: valor / parcelas,
                        pago: 0,
                        icon,
                        data: dataParcela.toISOString().split('T')[0],
                        monthKey: monthKey,
                        isBalance: false
                    });
                }

                alert("Conta(s) cadastrada(s)!");
                location.reload();
            },

            async quitar(id) {
                const item = this.allData.find(x => x.id === id);
                await db.collection('debts').doc(id).update({ pago: item.valor });
                this.fetchData();
            },

            async excluir(id) {
                if(confirm("Apagar registro?")) {
                    await db.collection('debts').doc(id).delete();
                    this.fetchData();
                }
            },

            // L√ìGICA DE SALDO
            renderSaldo() {
                const saldoItem = this.allData.find(x => x.isBalance);
                if(saldoItem && saldoItem.valor > 0) {
                    document.getElementById('area-saldo-atual').classList.remove('hidden');
                    document.getElementById('val-saldo-disponivel').innerText = this.fmt(saldoItem.valor);
                } else {
                    document.getElementById('area-saldo-atual').classList.add('hidden');
                }
            },

            async addSaldo() {
                const val = parseFloat(document.getElementById('input-saldo').value);
                if(!val) return;
                const monthKey = this.getMonthKey(this.currentMonth);
                const saldoItem = this.allData.find(x => x.isBalance);

                if(saldoItem) {
                    await db.collection('debts').doc(saldoItem.id).update({ valor: saldoItem.valor + val });
                } else {
                    await db.collection('debts').add({
                        seller: this.user.id,
                        isBalance: true,
                        valor: val,
                        monthKey: monthKey
                    });
                }
                document.getElementById('input-saldo').value = "";
                this.fetchData();
            },

            async distribuirSaldo() {
                const saldoItem = this.allData.find(x => x.isBalance);
                if(!saldoItem || saldoItem.valor <= 0) return alert("Sem saldo!");

                let saldoRestante = saldoItem.valor;
                const pendentes = this.allData.filter(x => !x.isBalance && x.pago < x.valor)
                                          .sort((a,b) => a.data.localeCompare(b.data));

                for(const item of pendentes) {
                    if(saldoRestante <= 0) break;
                    const falta = item.valor - item.pago;
                    const pagar = Math.min(falta, saldoRestante);
                    await db.collection('debts').doc(item.id).update({ pago: item.pago + pagar });
                    saldoRestante -= pagar;
                }

                await db.collection('debts').doc(saldoItem.id).update({ valor: saldoRestante });
                alert("Saldo distribu√≠do entre as contas!");
                this.fetchData();
            },

            // AUXILIARES
            getMonthKey(date) { return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`; },
            renderMonth() {
                const nomes = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
                document.getElementById('display-month').innerText = `${nomes[this.currentMonth.getMonth()]} ${this.currentMonth.getFullYear()}`;
            },
            changeMonth(n) { this.currentMonth.setMonth(this.currentMonth.getMonth() + n); this.renderMonth(); this.fetchData(); },
            fmt(v) { return v.toLocaleString('pt-BR', {style:'currency', currency:'BRL'}); },
            setTab(t) {
                document.getElementById('tab-kanban').classList.toggle('hidden', t !== 'kanban');
                document.getElementById('tab-graficos').classList.toggle('hidden', t !== 'graficos');
                document.getElementById('btn-tab-kanban').classList.toggle('active', t === 'kanban');
                document.getElementById('btn-tab-graficos').classList.toggle('active', t === 'graficos');
                if(t === 'graficos') this.renderChart();
            },
            toggleViewMode() { document.body.classList.toggle('notion-mode'); this.renderAll(); },
            exportCSV() {
                let csv = "Conta,Valor,Pago,Vencimento\n";
                this.allData.filter(x=>!x.isBalance).forEach(i => {
                    csv += `${i.nome},${i.valor},${i.pago},${i.data}\n`;
                });
                const blob = new Blob([csv], {type: 'text/csv'});
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = 'financeiro.csv'; a.click();
            },
            renderChart() {
                const ctx = document.getElementById('meuGrafico').getContext('2d');
                if(window.chartObj) window.chartObj.destroy();
                const regular = this.allData.filter(x => !x.isBalance);
                window.chartObj = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Pago', 'Pendente'],
                        datasets: [{
                            data: [regular.reduce((s,v)=>s+v.pago,0), regular.reduce((s,v)=>s+(v.valor-v.pago),0)],
                            backgroundColor: ['#10b981', '#ef4444']
                        }]
                    },
                    options: { plugins: { legend: { labels: { color: document.body.classList.contains('notion-mode') ? '#333' : '#fff' } } } }
                });
            }
        };

        fin.init();
    </script>
</body>
</html>
